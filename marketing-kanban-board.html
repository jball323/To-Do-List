<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketing Projects Board</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='12' width='100' height='100' fill='%23334155'/><rect x='10' y='25' rx='4' width='22' height='55' fill='%23a78bfa'/><rect x='39' y='25' rx='4' width='22' height='55' fill='%2360a5fa'/><rect x='68' y='25' rx='4' width='22' height='55' fill='%2334d399'/></svg>">
<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  .title-gradient {
    background: linear-gradient(135deg, #a78bfa, #60a5fa, #fbbf24, #34d399);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-bottom: 0.15em;
    overflow: visible;
    line-height: 1.3;
  }
  .col-header-triage { background: linear-gradient(135deg, #7c3aed, #a78bfa); }
  .col-header-todo { background: linear-gradient(135deg, #2563eb, #60a5fa); }
  .col-header-inprogress { background: linear-gradient(135deg, #d97706, #fbbf24); }
  .col-header-done { background: linear-gradient(135deg, #059669, #34d399); }
  .sidebar-header { background: linear-gradient(135deg, #475569, #64748b); }
  .task-card {
    transition: box-shadow 0.25s ease, transform 0.25s ease, opacity 0.25s ease;
    cursor: grab;
  }
  .task-card:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    transform: translateY(-2px);
  }
  .task-card.dragging {
    opacity: 0.4;
    transform: rotate(3deg) scale(1.02);
  }
  .task-card-done { opacity: 0.55; }
  .task-card-done:hover { opacity: 0.75; }
  .task-card-done .task-desc {
    text-decoration: line-through;
    text-decoration-color: rgba(148, 163, 184, 0.5);
  }
  .column-drop-zone {
    min-height: 80px;
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
  }
  .column-drop-zone.drag-over {
    background-color: rgba(255,255,255,0.04);
    box-shadow: inset 0 0 20px rgba(255,255,255,0.03);
  }
  @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes modalSlideIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  .modal-overlay {
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    animation: modalFadeIn 0.2s ease;
  }
  .modal-content { animation: modalSlideIn 0.25s ease; }
  @keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }
  .sidebar-overlay-panel { animation: slideInRight 0.25s ease; }
  .scrollbar-thin::-webkit-scrollbar { width: 6px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }
  .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.22); }
  .add-btn { transition: background-color 0.2s ease, transform 0.15s ease; }
  .add-btn:hover { transform: scale(1.1); }
  .add-btn:active { transform: scale(0.95); }
  .action-btn {
    transition: color 0.15s ease, background-color 0.15s ease;
    min-width: 26px; min-height: 26px;
    display: flex; align-items: center; justify-content: center;
  }
  .card-actions {
    opacity: 0; transition: opacity 0.15s ease;
    position: absolute; right: 0; top: 0;
  }
  .task-card:hover .card-actions { opacity: 1; }
  .column-container { transition: border-color 0.2s ease; }
  .todo-item { transition: background-color 0.15s ease, opacity 0.3s ease; }
  .todo-item:hover { background-color: rgba(255,255,255,0.04); }
  .todo-item.completed-item { opacity: 0.5; }
  .todo-item.completed-item p { text-decoration: line-through; }
  .todo-checkbox {
    appearance: none; -webkit-appearance: none;
    width: 16px; height: 16px;
    border: 2px solid #475569; border-radius: 4px;
    cursor: pointer; transition: all 0.15s ease;
    flex-shrink: 0; position: relative;
  }
  .todo-checkbox:checked {
    background: linear-gradient(135deg, #64748b, #94a3b8);
    border-color: #64748b;
  }
  .todo-checkbox:checked::after {
    content: ''; position: absolute; left: 3px; top: 0px;
    width: 5px; height: 9px;
    border: solid white; border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }
  .todo-checkbox:hover { border-color: #94a3b8; }
  .sidebar-panel {
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(51, 65, 85, 0.5);
  }
  .todo-input:focus {
    outline: none; border-color: #64748b;
    box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.25);
  }
  select, select option { color-scheme: dark; background-color: #0f172a; color: white; }
  @keyframes confirmSlideIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .confirm-bar { animation: confirmSlideIn 0.15s ease; }
  .sidebar-toggle { transition: background-color 0.2s ease, transform 0.15s ease; }
  .sidebar-toggle:hover { transform: scale(1.05); }
  .sidebar-toggle:active { transform: scale(0.95); }
  .empty-ghost {
    border: 1px dashed rgba(100, 116, 139, 0.3);
    border-radius: 8px; padding: 20px 16px;
  }
  .scroll-fade-bottom { position: relative; }
  .scroll-fade-bottom::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0;
    height: 24px;
    background: linear-gradient(to bottom, transparent, rgba(15, 23, 42, 0.7));
    pointer-events: none; border-radius: 0 0 12px 12px;
  }
  .desc-textarea {
    resize: none; min-height: 40px; max-height: 120px;
  }
  .description-clamp {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .notes-preview {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .move-menu {
    position: absolute; right: 0; top: 100%; z-index: 30;
    background: #1e293b; border: 1px solid #475569;
    border-radius: 8px; padding: 4px; min-width: 130px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  }
  .move-menu-item {
    display: block; width: 100%; text-align: left;
    padding: 6px 10px; font-size: 13px; color: #cbd5e1;
    border-radius: 6px; transition: background-color 0.15s;
    border: none; background: none; cursor: pointer;
  }
  .move-menu-item:hover { background: rgba(255,255,255,0.08); color: white; }
  .insertion-marker {
    height: 2px; border-radius: 1px; margin: 4px 0;
    background: linear-gradient(90deg, #3b82f6, #6366f1);
    animation: markerPulse 1s ease infinite alternate;
  }
  @keyframes markerPulse { from { opacity: 0.6; } to { opacity: 1; } }
  @keyframes toastSlideUp {
    from { opacity: 0; transform: translateX(-50%) translateY(10px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }
  .undo-toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: #334155; border: 1px solid #475569; color: white;
    padding: 10px 16px; border-radius: 12px; font-size: 14px;
    display: flex; align-items: center; gap: 12px; z-index: 60;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    animation: toastSlideUp 0.25s ease;
  }
  .columns-scroll-wrapper { position: relative; }
  .columns-scroll-wrapper::after {
    content: ''; position: absolute; right: 0; top: 0; bottom: 0;
    width: 40px; pointer-events: none; z-index: 5;
    background: linear-gradient(to right, transparent, rgba(15, 23, 42, 0.9));
  }
  @media (min-width: 1024px) {
    .columns-scroll-wrapper::after { display: none; }
  }
  .search-bar:focus {
    outline: none; border-color: #6366f1 !important;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
  }
  .todo-edit-input:focus {
    outline: none; border-color: #64748b;
    box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.25);
  }
  .header-action-btn {
    padding: 6px 12px; font-size: 12px; border-radius: 8px;
    color: #94a3b8; border: 1px solid #334155; background: rgba(30,41,59,0.8);
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .header-action-btn:hover { color: white; border-color: #475569; }
  .share-copied {
    color: #34d399 !important; border-color: #34d399 !important;
  }

  /* Mobile optimizations */
  .mobile-column-tabs { display: none; }
  .mobile-move-btn { display: none; }
  @media (max-width: 1023px) {
    .mobile-column-tabs {
      display: flex; gap: 4px; padding: 0 4px; margin-bottom: 12px;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    .mobile-tab {
      flex: 1; min-width: 0; padding: 8px 4px;
      border-radius: 10px; background: rgba(30, 41, 59, 0.8);
      color: #94a3b8; font-size: 13px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center;
      justify-content: center; gap: 6px; transition: all 0.15s;
      border: 1px solid rgba(51, 65, 85, 0.5);
    }
    .mobile-tab-active {
      background: rgba(99, 102, 241, 0.15);
      color: white; border-color: rgba(99, 102, 241, 0.4);
    }
    .mobile-tab-badge {
      font-size: 11px; font-weight: 700;
      background: rgba(255,255,255,0.1);
      padding: 1px 7px; border-radius: 9999px;
    }
    .mobile-tab-active .mobile-tab-badge {
      background: rgba(99, 102, 241, 0.3);
    }
    .column-container {
      min-width: 0 !important; max-width: none !important;
      flex: 1 1 100% !important;
    }
    .columns-scroll-wrapper::after { display: none; }
    .card-actions {
      opacity: 1; position: static;
      background: transparent !important;
      padding-left: 0 !important;
    }
    .grip-handle { display: none; }
    .task-card { cursor: default; }
    .task-card:hover { transform: none; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    .mobile-move-btn { display: flex; }
    .todo-delete-btn { opacity: 1 !important; }
  }
  @media (max-width: 639px) {
    .search-filter-bar { flex-wrap: wrap; }
    .search-input-wrapper { flex: 1 1 100% !important; max-width: none !important; margin-bottom: 8px; }
    .header-actions-group {
      position: static !important; transform: none !important;
      justify-content: center; margin-top: 8px;
    }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAoXVLbEkVECRlj_JcGONTwbTx59rXpsk0",
  authDomain: "marketing-projects-board.firebaseapp.com",
  databaseURL: "https://marketing-projects-board-default-rtdb.firebaseio.com",
  projectId: "marketing-projects-board",
  storageBucket: "marketing-projects-board.firebasestorage.app",
  messagingSenderId: "746265583777",
  appId: "1:746265583777:web:13b3fdad1d5ebe0f72d0e0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const KANBAN_KEY = 'marketing-kanban-board-v2';
const TODOS_KEY = 'marketing-personal-todos-v1';
const BOARD_ID_KEY = 'marketing-board-id';

function getBoardId() {
  let id = window.location.hash.replace('#', '');
  if (id) {
    localStorage.setItem(BOARD_ID_KEY, id);
    return id;
  }
  id = localStorage.getItem(BOARD_ID_KEY);
  if (id) {
    window.location.hash = id;
    return id;
  }
  id = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2, 11);
  localStorage.setItem(BOARD_ID_KEY, id);
  window.location.hash = id;
  return id;
}

function toArray(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val.filter(Boolean);
  return Object.values(val).filter(Boolean);
}

const COLUMNS = [
  { id: 'triage', title: 'Triage', headerClass: 'col-header-triage' },
  { id: 'todo', title: 'To Do', headerClass: 'col-header-todo' },
  { id: 'inprogress', title: 'In Progress', headerClass: 'col-header-inprogress' },
  { id: 'done', title: 'Done', headerClass: 'col-header-done' },
];

const CATEGORIES = [
  { value: 'social-media', label: 'Social Media', color: '#ec4899' },
  { value: 'email-campaign', label: 'Email Campaign', color: '#3b82f6' },
  { value: 'content', label: 'Content', color: '#8b5cf6' },
  { value: 'events', label: 'Events', color: '#f97316' },
  { value: 'brand', label: 'Brand', color: '#6366f1' },
  { value: 'analytics', label: 'Analytics', color: '#14b8a6' },
  { value: 'seo', label: 'SEO', color: '#22c55e' },
  { value: 'other', label: 'Other', color: '#94a3b8' },
];

const CATEGORY_MAP = Object.fromEntries(CATEGORIES.map(c => [c.value, c]));

function getCat(value) {
  return CATEGORY_MAP[value] || CATEGORY_MAP['other'];
}

function generateId() {
  return crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2, 11);
}

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'Good morning';
  if (h < 17) return 'Good afternoon';
  return 'Good evening';
}

function getFormattedDate() {
  return new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
}

// SVG Icons
function GripIcon() {
  return (
    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
      <circle cx="5" cy="2.5" r="1.3"/><circle cx="11" cy="2.5" r="1.3"/>
      <circle cx="5" cy="7.5" r="1.3"/><circle cx="11" cy="7.5" r="1.3"/>
      <circle cx="5" cy="12.5" r="1.3"/><circle cx="11" cy="12.5" r="1.3"/>
    </svg>
  );
}

function PencilIcon() {
  return (
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
    </svg>
  );
}

function XIcon({ size = 14 }) {
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  );
}

function PlusIcon({ size = 15 }) {
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
  );
}

function SidebarIcon() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  );
}

function CheckIcon() {
  return (
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
      <polyline points="20 6 9 17 4 12"/>
    </svg>
  );
}

function NotebookIcon() {
  return (
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="9" y1="7" x2="17" y2="7"/><line x1="9" y1="11" x2="17" y2="11"/>
    </svg>
  );
}

function ArrowIcon() {
  return (
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg>
  );
}

function SearchIcon() {
  return (
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
  );
}

function ShareIcon() {
  return (
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
    </svg>
  );
}

function MoreDotsIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
    </svg>
  );
}

// Error Boundary
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }
  static getDerivedStateFromError() { return { hasError: true }; }
  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex items-center justify-center" style={{ background: '#0f172a' }}>
          <div className="text-center">
            <h2 className="text-xl font-bold text-white mb-3">Something went wrong</h2>
            <button onClick={() => this.setState({ hasError: false })} className="px-4 py-2 text-sm text-white rounded-lg" style={{ background: '#3b82f6' }}>
              Try again
            </button>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

// Mobile column tabs
function ColumnTabs({ activeTab, onTabChange, tasksByColumn }) {
  return (
    <div className="mobile-column-tabs" style={{ maxWidth: '1600px', margin: '0 auto' }}>
      {COLUMNS.map(col => (
        <button
          key={col.id}
          onClick={() => onTabChange(col.id)}
          className={`mobile-tab ${activeTab === col.id ? 'mobile-tab-active' : ''}`}
        >
          <span>{col.title}</span>
          <span className="mobile-tab-badge">{tasksByColumn[col.id].length}</span>
        </button>
      ))}
    </div>
  );
}

// Mobile more menu (Share/Export/Import)
function MoreMenu({ onShare, onExport, onImport, shareCopied }) {
  const [open, setOpen] = useState(false);
  const ref = useRef(null);

  useEffect(() => {
    if (!open) return;
    const handleClick = (e) => {
      if (ref.current && !ref.current.contains(e.target)) setOpen(false);
    };
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, [open]);

  return (
    <div className="relative sm:hidden" ref={ref}>
      <button onClick={() => setOpen(!open)} className="header-action-btn flex items-center justify-center" aria-label="More actions" style={{ padding: '6px 8px' }}>
        <MoreDotsIcon />
      </button>
      {open && (
        <div className="move-menu" style={{ right: 0, top: '100%', marginTop: '4px', zIndex: 40 }}>
          <button className="move-menu-item" onClick={() => { onShare(); setOpen(false); }}>{shareCopied ? 'Copied!' : 'Share Link'}</button>
          <button className="move-menu-item" onClick={() => { onExport(); setOpen(false); }}>Export</button>
          <button className="move-menu-item" onClick={() => { onImport(); setOpen(false); }}>Import</button>
        </div>
      )}
    </div>
  );
}

// Task Modal with focus trap + ARIA
function TaskModal({ isOpen, onClose, onSave, initialData, defaultColumn }) {
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState('other');
  const [notes, setNotes] = useState('');
  const inputRef = useRef(null);
  const modalRef = useRef(null);

  useEffect(() => {
    if (isOpen) {
      if (initialData) {
        setDescription(initialData.description);
        setCategory(initialData.category);
        setNotes(initialData.notes || '');
      } else {
        setDescription('');
        setCategory('other');
        setNotes('');
      }
      setTimeout(() => inputRef.current?.focus(), 80);
    }
  }, [isOpen, initialData]);

  useEffect(() => {
    if (!isOpen) return;
    const handleKey = (e) => {
      if (e.key === 'Escape') { onClose(); return; }
      if (e.key === 'Tab' && modalRef.current) {
        const focusable = modalRef.current.querySelectorAll('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault(); last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault(); first.focus();
        }
      }
    };
    document.addEventListener('keydown', handleKey);
    return () => document.removeEventListener('keydown', handleKey);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!description.trim()) return;
    onSave({ description: description.trim(), category, notes: notes.trim() });
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onClick={onClose}>
      <div
        ref={modalRef}
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
        className="modal-content rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4"
        style={{ background: '#1e293b', border: '1px solid #334155' }}
        onClick={e => e.stopPropagation()}
      >
        <h3 id="modal-title" className="text-lg font-semibold text-white mb-5">
          {initialData ? 'Edit Task' : 'New Task'}
        </h3>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label htmlFor="task-description" className="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5">Description</label>
            <textarea
              id="task-description"
              ref={inputRef}
              value={description}
              onChange={e => setDescription(e.target.value)}
              placeholder="What needs to be done?"
              rows={2}
              className="desc-textarea w-full px-3 py-2.5 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              style={{ background: '#0f172a', border: '1px solid #334155' }}
              onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(e); } }}
            />
          </div>
          <div className="mb-4">
            <label htmlFor="task-category" className="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5">Project Category</label>
            <select
              id="task-category"
              value={category}
              onChange={e => setCategory(e.target.value)}
              className="w-full px-3 py-2.5 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              style={{ background: '#0f172a', border: '1px solid #334155', colorScheme: 'dark' }}
            >
              {CATEGORIES.map(cat => (
                <option key={cat.value} value={cat.value} style={{ background: '#0f172a', color: 'white' }}>{cat.label}</option>
              ))}
            </select>
          </div>
          <div className="mb-6">
            <label htmlFor="task-notes" className="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5">Notes</label>
            <textarea
              id="task-notes"
              value={notes}
              onChange={e => setNotes(e.target.value)}
              placeholder="Add detailed notes, links, context..."
              rows={3}
              className="w-full px-3 py-2.5 rounded-lg text-white text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              style={{ background: '#0f172a', border: '1px solid #334155', resize: 'vertical', minHeight: '60px', maxHeight: '200px' }}
            />
          </div>
          <div className="flex justify-end gap-3">
            <button type="button" onClick={onClose}
              className="px-4 py-2 text-sm font-medium text-gray-300 rounded-lg hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500"
              style={{ background: '#334155' }}
            >Cancel</button>
            <button type="submit"
              className="px-5 py-2 text-sm font-medium text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
              style={{ background: 'linear-gradient(135deg, #3b82f6, #6366f1)' }}
            >{initialData ? 'Save' : 'Add Task'}</button>
          </div>
        </form>
      </div>
    </div>
  );
}

// Delete confirmation with focus management
function DeleteConfirm({ onConfirm, onCancel }) {
  return (
    <div className="confirm-bar flex items-center gap-2 px-2.5 py-2 rounded-lg text-xs" role="alertdialog" aria-label="Confirm deletion" style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)' }}>
      <span className="text-red-400 flex-1">Delete this task?</span>
      <button onClick={onConfirm} autoFocus className="px-2.5 py-1 rounded text-white text-xs font-medium" style={{ background: '#ef4444' }}>Yes</button>
      <button onClick={onCancel} className="px-2.5 py-1 rounded text-gray-400 hover:text-white text-xs font-medium" style={{ background: '#334155' }}>No</button>
    </div>
  );
}

// Undo Toast
function UndoToast({ message, onUndo, onDismiss }) {
  return (
    <div className="undo-toast">
      <span className="text-sm text-gray-300">{message}</span>
      <button onClick={onUndo} className="text-sm font-semibold text-blue-400 hover:text-blue-300 transition-colors">Undo</button>
      <button onClick={onDismiss} className="text-gray-500 hover:text-gray-300 transition-colors"><XIcon size={12} /></button>
    </div>
  );
}

// Task Card with mobile move menu
function TaskCard({ task, onEdit, onDelete, onMove, isDone }) {
  const cat = getCat(task.category);
  const [confirmDelete, setConfirmDelete] = useState(false);
  const [showMoveMenu, setShowMoveMenu] = useState(false);
  const moveMenuRef = useRef(null);

  useEffect(() => {
    if (!showMoveMenu) return;
    const handleClick = (e) => {
      if (moveMenuRef.current && !moveMenuRef.current.contains(e.target)) setShowMoveMenu(false);
    };
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, [showMoveMenu]);

  const handleDragStart = (e) => {
    e.dataTransfer.setData('application/kanban-task', task.id);
    e.dataTransfer.effectAllowed = 'move';
    requestAnimationFrame(() => { e.target.classList.add('dragging'); });
  };
  const handleDragEnd = (e) => { e.target.classList.remove('dragging'); };

  const touchRef = useRef({ startX: 0, startY: 0, dragging: false });
  const handleTouchStart = (e) => {
    const t = e.touches[0];
    touchRef.current = { startX: t.clientX, startY: t.clientY, dragging: false };
  };
  const handleTouchEnd = (e) => {
    if (!touchRef.current.dragging) return;
    touchRef.current.dragging = false;
  };

  return (
    <div>
      <div
        draggable="true"
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}
        className={`task-card rounded-lg shadow-md ${isDone ? 'task-card-done' : ''}`}
        style={{ background: '#1e293b', borderLeft: `3px solid ${cat.color}`, padding: '8px 10px' }}
        title="Drag to move"
      >
        <div className="flex items-center gap-2 relative">
          <div className="grip-handle flex-shrink-0 text-gray-400 hover:text-gray-300 cursor-grab" style={{ transition: 'color 0.15s' }}>
            <GripIcon />
          </div>
          <div className="flex-1 min-w-0">
            <p className="task-desc text-sm font-medium text-gray-100 leading-snug break-words description-clamp">{task.description}</p>
            <div className="flex items-center justify-end gap-1 mt-1">
              {isDone && <span className="text-green-400"><CheckIcon /></span>}
              <span
                className="inline-block px-1.5 py-px rounded-full text-xs font-semibold"
                style={{ backgroundColor: cat.color + '2a', color: cat.color, border: `1px solid ${cat.color}66`, fontSize: '10px' }}
              >{cat.label}</span>
              {task.notes && (
                <button onClick={(e) => { e.stopPropagation(); onEdit(task); }} className="text-gray-400 hover:text-blue-400 flex-shrink-0 cursor-pointer" title="View notes" style={{ background: 'none', border: 'none', padding: 0, transition: 'color 0.15s' }}><NotebookIcon /></button>
              )}
            </div>
          </div>
          <div className="card-actions flex items-center gap-0 flex-shrink-0" style={{ background: '#1e293b', paddingLeft: '4px' }}>
            <button onClick={() => onEdit(task)} className="action-btn text-gray-400 hover:text-blue-400 rounded-md hover:bg-gray-700" aria-label="Edit task" title="Edit">
              <PencilIcon />
            </button>
            <button onClick={(e) => { e.stopPropagation(); setShowMoveMenu(!showMoveMenu); }} className="action-btn text-gray-400 hover:text-green-400 rounded-md hover:bg-gray-700 mobile-move-btn" aria-label="Move task" title="Move to column">
              <ArrowIcon />
            </button>
            <button onClick={() => setConfirmDelete(true)} className="action-btn text-gray-400 hover:text-red-400 rounded-md hover:bg-gray-700" aria-label="Delete task" title="Delete">
              <XIcon />
            </button>
          </div>
          {showMoveMenu && (
            <div ref={moveMenuRef} className="move-menu" style={{ right: 0, top: '100%', marginTop: '4px' }}>
              {COLUMNS.filter(c => c.id !== task.columnId).map(col => (
                <button key={col.id} className="move-menu-item" onClick={() => { onMove(task.id, col.id); setShowMoveMenu(false); }}>
                  {col.title}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
      {confirmDelete && (
        <div className="mt-1.5">
          <DeleteConfirm onConfirm={() => onDelete(task.id)} onCancel={() => setConfirmDelete(false)} />
        </div>
      )}
    </div>
  );
}

// Column with intra-column reordering
function Column({ column, tasks, onAddClick, onEditTask, onDeleteTask, onDrop, onMoveTask, onClearDone, hidden }) {
  const [dragOver, setDragOver] = useState(false);
  const [insertBeforeId, setInsertBeforeId] = useState(null);
  const isDone = column.id === 'done';

  if (hidden) return null;

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if (!dragOver) setDragOver(true);
    setInsertBeforeId(null);
  };

  const handleDragLeave = (e) => {
    if (!e.currentTarget.contains(e.relatedTarget)) {
      setDragOver(false);
      setInsertBeforeId(null);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    const taskId = e.dataTransfer.getData('application/kanban-task');
    if (taskId) onDrop(taskId, column.id, null);
    setInsertBeforeId(null);
  };

  const handleCardDragOver = (e, taskId) => {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = 'move';
    const rect = e.currentTarget.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    if (e.clientY < midY) {
      setInsertBeforeId(taskId);
    } else {
      const idx = tasks.findIndex(t => t.id === taskId);
      setInsertBeforeId(idx < tasks.length - 1 ? tasks[idx + 1].id : null);
    }
    if (!dragOver) setDragOver(true);
  };

  const handleCardDrop = (e, taskId, index) => {
    e.preventDefault();
    e.stopPropagation();
    const draggedId = e.dataTransfer.getData('application/kanban-task');
    if (!draggedId) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    const beforeId = e.clientY < midY ? taskId : (index < tasks.length - 1 ? tasks[index + 1].id : null);
    onDrop(draggedId, column.id, beforeId);
    setDragOver(false);
    setInsertBeforeId(null);
  };

  return (
    <div className="column-container flex flex-col rounded-xl overflow-hidden"
      style={{ minWidth: '250px', maxWidth: '360px', flex: '1 1 250px', background: 'rgba(15, 23, 42, 0.7)', border: '1px solid rgba(51, 65, 85, 0.5)' }}
    >
      <div className={`${column.headerClass} px-4 py-3.5 flex items-center justify-between`}>
        <div className="flex items-center gap-2.5">
          <h2 className="font-bold text-white text-base tracking-wide">{column.title}</h2>
          <span className="text-xs font-bold px-2.5 py-1 rounded-full text-center" style={{ background: 'rgba(255,255,255,0.2)', color: 'white', minWidth: '26px' }}>
            {tasks.length}
          </span>
        </div>
        <div className="flex items-center gap-1.5">
          {isDone && tasks.length > 0 && onClearDone && (
            <button onClick={onClearDone} className="text-xs text-white font-medium px-2 py-1 rounded-lg hover:bg-white hover:bg-opacity-20 transition-colors" title="Clear all done tasks">
              Clear
            </button>
          )}
          <button onClick={() => onAddClick(column.id)} className="add-btn p-1.5 rounded-lg text-white" style={{ background: 'rgba(255,255,255,0.2)' }} aria-label={`Add task to ${column.title}`} title={`Add task to ${column.title}`}>
            <PlusIcon />
          </button>
        </div>
      </div>
      <div
        className={`column-drop-zone scroll-fade-bottom flex-1 p-4 space-y-3 overflow-y-auto scrollbar-thin ${dragOver ? 'drag-over' : ''}`}
        style={{ maxHeight: 'calc(100dvh - 220px)' }}
        onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}
      >
        {tasks.map((task, index) => (
          <div key={task.id} onDragOver={e => handleCardDragOver(e, task.id)} onDrop={e => handleCardDrop(e, task.id, index)}>
            {insertBeforeId === task.id && <div className="insertion-marker" />}
            <TaskCard task={task} onEdit={onEditTask} onDelete={onDeleteTask} onMove={onMoveTask} isDone={isDone} />
          </div>
        ))}
        {dragOver && insertBeforeId === null && tasks.length > 0 && (
          <div className="insertion-marker" />
        )}
        {tasks.length === 0 && (
          <div className="empty-ghost text-center text-gray-400 text-sm cursor-pointer hover:text-gray-300 hover:border-gray-400 transition-colors" onClick={() => onAddClick(column.id)}>
            {dragOver ? 'Drop here' : 'Click to add a task'}
          </div>
        )}
      </div>
    </div>
  );
}

// Personal To-Dos Sidebar (receives todos + updateTodos from parent)
function PersonalSidebar({ todos, updateTodos, onClose }) {
  const [newTodo, setNewTodo] = useState('');
  const [dragTodoId, setDragTodoId] = useState(null);
  const [dragOverId, setDragOverId] = useState(null);
  const [editingTodoId, setEditingTodoId] = useState(null);
  const [editingTodoText, setEditingTodoText] = useState('');
  const inputRef = useRef(null);
  const editRef = useRef(null);

  useEffect(() => {
    if (editingTodoId && editRef.current) editRef.current.focus();
  }, [editingTodoId]);

  const addTodo = (e) => {
    e.preventDefault();
    if (!newTodo.trim()) return;
    updateTodos(prev => [{ id: generateId(), text: newTodo.trim(), done: false }, ...prev]);
    setNewTodo('');
    inputRef.current?.focus();
  };

  const toggleTodo = (id) => {
    updateTodos(prev => prev.map(t => t.id === id ? { ...t, done: !t.done } : t));
  };

  const deleteTodo = (id) => {
    updateTodos(prev => prev.filter(t => t.id !== id));
  };

  const clearCompleted = () => {
    updateTodos(prev => prev.filter(t => !t.done));
  };

  const startEditTodo = (todo) => {
    setEditingTodoId(todo.id);
    setEditingTodoText(todo.text);
  };

  const saveEditTodo = () => {
    if (editingTodoText.trim()) {
      updateTodos(prev => prev.map(t => t.id === editingTodoId ? { ...t, text: editingTodoText.trim() } : t));
    }
    setEditingTodoId(null);
  };

  const handleTodoDragStart = (e, id) => {
    setDragTodoId(id);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', id);
    requestAnimationFrame(() => { e.target.style.opacity = '0.4'; });
  };

  const handleTodoDragEnd = (e) => {
    e.target.style.opacity = '';
    setDragTodoId(null);
    setDragOverId(null);
  };

  const handleTodoDragOver = (e, id) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if (id !== dragOverId) setDragOverId(id);
  };

  const handleTodoDrop = (e, targetId) => {
    e.preventDefault();
    if (!dragTodoId || dragTodoId === targetId) return;
    updateTodos(prev => {
      const fromIdx = prev.findIndex(t => t.id === dragTodoId);
      const toIdx = prev.findIndex(t => t.id === targetId);
      if (fromIdx === -1 || toIdx === -1) return prev;
      const updated = [...prev];
      const [moved] = updated.splice(fromIdx, 1);
      updated.splice(toIdx, 0, moved);
      return updated;
    });
    setDragTodoId(null);
    setDragOverId(null);
  };

  const completedCount = todos.filter(t => t.done).length;
  const totalCount = todos.length;
  const progressPct = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

  return (
    <div className="sidebar-panel rounded-xl overflow-hidden flex flex-col" style={{ width: '300px', minWidth: '300px', maxHeight: 'calc(100dvh - 220px)' }}>
      <div className="sidebar-header px-4 py-3.5 flex items-center justify-between">
        <h2 className="font-bold text-white text-base tracking-wide">Personal To-Dos</h2>
        {onClose && (
          <button onClick={onClose} className="p-1 rounded-md text-white hover:bg-white hover:bg-opacity-20 transition-colors lg:hidden" aria-label="Close sidebar">
            <XIcon size={16} />
          </button>
        )}
      </div>

      <div className="flex flex-col flex-1 overflow-hidden">
        <form onSubmit={addTodo} className="p-3.5" style={{ borderBottom: '1px solid rgba(51,65,85,0.3)' }}>
          <div className="flex gap-2 items-center">
            <input
              ref={inputRef}
              type="text"
              value={newTodo}
              onChange={e => setNewTodo(e.target.value)}
              placeholder="Add a to-do..."
              className="todo-input flex-1 px-2.5 py-2 rounded-lg text-sm text-white placeholder-gray-500"
              style={{ background: '#0f172a', border: '1px solid #334155', minWidth: 0 }}
            />
            <button type="submit" className="add-btn rounded-lg text-white flex-shrink-0 flex items-center justify-center" style={{ background: 'linear-gradient(135deg, #475569, #64748b)', width: '34px', height: '34px' }} aria-label="Add to-do" title="Add to-do">
              <PlusIcon size={13} />
            </button>
          </div>
        </form>

        {totalCount > 0 && (
          <div className="px-3.5 pt-2.5 pb-1">
            <div className="flex items-center justify-between mb-1">
              <span className="text-xs text-gray-400">{completedCount} of {totalCount} done</span>
              {completedCount > 0 && (
                <button onClick={clearCompleted} className="text-xs text-gray-400 hover:text-red-400 transition-colors">
                  Clear done
                </button>
              )}
            </div>
            <div className="w-full rounded-full h-1" style={{ background: '#1e293b' }}
              role="progressbar" aria-valuenow={progressPct} aria-valuemin={0} aria-valuemax={100} aria-label={`${completedCount} of ${totalCount} to-dos completed`}
            >
              <div
                className="h-1 rounded-full transition-all"
                style={{ width: `${progressPct}%`, background: 'linear-gradient(135deg, #475569, #94a3b8)' }}
              />
            </div>
          </div>
        )}

        <div className="flex-1 overflow-y-auto scrollbar-thin p-2" style={{ paddingBottom: '16px' }}>
          {todos.map(todo => (
            <div
              key={todo.id}
              draggable={editingTodoId !== todo.id}
              onDragStart={e => handleTodoDragStart(e, todo.id)}
              onDragEnd={handleTodoDragEnd}
              onDragOver={e => handleTodoDragOver(e, todo.id)}
              onDrop={e => handleTodoDrop(e, todo.id)}
              className={`todo-item flex items-start gap-2 px-2 py-2.5 rounded-lg group ${todo.done ? 'completed-item' : ''}`}
              style={{ borderTop: dragOverId === todo.id && dragTodoId !== todo.id ? '2px solid #64748b' : '2px solid transparent', cursor: editingTodoId === todo.id ? 'default' : 'grab' }}
            >
              <div className="flex-shrink-0 mt-0.5 text-gray-500 hover:text-gray-400 cursor-grab" style={{ transition: 'color 0.15s' }}>
                <GripIcon />
              </div>
              <input
                type="checkbox"
                checked={todo.done}
                onChange={() => toggleTodo(todo.id)}
                className="todo-checkbox mt-0.5"
              />
              {editingTodoId === todo.id ? (
                <input
                  ref={editRef}
                  type="text"
                  value={editingTodoText}
                  onChange={e => setEditingTodoText(e.target.value)}
                  onBlur={saveEditTodo}
                  onKeyDown={e => { if (e.key === 'Enter') saveEditTodo(); if (e.key === 'Escape') setEditingTodoId(null); }}
                  className="todo-edit-input flex-1 px-1.5 py-0.5 rounded text-sm text-white"
                  style={{ background: '#0f172a', border: '1px solid #475569', minWidth: 0 }}
                />
              ) : (
                <p
                  className={`text-sm flex-1 leading-snug break-words ${todo.done ? 'text-gray-400' : 'text-gray-300'}`}
                  onDoubleClick={() => startEditTodo(todo)}
                  title="Double-click to edit"
                >
                  {todo.text}
                </p>
              )}
              <button
                onClick={() => deleteTodo(todo.id)}
                className="todo-delete-btn action-btn p-1.5 text-gray-500 hover:text-red-400 rounded opacity-0 group-hover:opacity-100 flex-shrink-0"
                style={{ minWidth: '28px', minHeight: '28px' }}
                aria-label="Delete to-do"
                title="Delete"
              >
                <XIcon size={12} />
              </button>
            </div>
          ))}
          {todos.length === 0 && (
            <div className="empty-ghost text-center text-gray-400 text-sm mt-2">
              Add your first to-do above
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Mobile sidebar overlay
function MobileSidebarOverlay({ isOpen, onClose, todos, updateTodos }) {
  useEffect(() => {
    if (!isOpen) return;
    const handleKey = (e) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('keydown', handleKey);
    return () => document.removeEventListener('keydown', handleKey);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-40 lg:hidden" onClick={onClose}>
      <div className="absolute inset-0" style={{ background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(4px)' }} />
      <div className="absolute right-0 top-0 h-full flex items-start pt-4 pr-4 pb-4 sidebar-overlay-panel" onClick={e => e.stopPropagation()}>
        <PersonalSidebar todos={todos} updateTodos={updateTodos} onClose={onClose} />
      </div>
    </div>
  );
}

// Main App
function App() {
  const [tasks, setTasks] = useState([]);
  const [todos, setTodos] = useState([]);
  const [loading, setLoading] = useState(true);
  const [boardId] = useState(() => getBoardId());
  const [modalOpen, setModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [activeColumnId, setActiveColumnId] = useState(null);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterCategory, setFilterCategory] = useState('');
  const [undoTask, setUndoTask] = useState(null);
  const [shareCopied, setShareCopied] = useState(false);
  const [mobileColumnTab, setMobileColumnTab] = useState('triage');
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 1024);
  const undoTimerRef = useRef(null);

  const tasksRef = useRef([]);
  const todosRef = useRef([]);
  const boardRef = useRef(null);

  // Track mobile breakpoint
  useEffect(() => {
    const handler = () => setIsMobile(window.innerWidth < 1024);
    window.addEventListener('resize', handler);
    return () => window.removeEventListener('resize', handler);
  }, []);

  // Firebase init + listeners
  useEffect(() => {
    const bRef = db.ref(`boards/${boardId}`);
    boardRef.current = bRef;

    auth.signInAnonymously().then(() => {
      bRef.child('tasks').once('value').then(snap => {
        if (!snap.val()) {
          try {
            const localTasks = JSON.parse(localStorage.getItem(KANBAN_KEY) || '[]');
            const localTodos = JSON.parse(localStorage.getItem(TODOS_KEY) || '[]');
            if (localTasks.length) bRef.child('tasks').set(localTasks);
            if (localTodos.length) bRef.child('todos').set(localTodos);
          } catch {}
        }
        localStorage.removeItem(KANBAN_KEY);
        localStorage.removeItem(TODOS_KEY);

        bRef.child('tasks').on('value', snapshot => {
          const arr = toArray(snapshot.val());
          tasksRef.current = arr;
          setTasks(arr);
          setLoading(false);
        });

        bRef.child('todos').on('value', snapshot => {
          const arr = toArray(snapshot.val());
          todosRef.current = arr;
          setTodos(arr);
        });
      });
    }).catch(() => {
      try { setTasks(JSON.parse(localStorage.getItem(KANBAN_KEY) || '[]')); } catch {}
      try { setTodos(JSON.parse(localStorage.getItem(TODOS_KEY) || '[]')); } catch {}
      setLoading(false);
    });

    return () => {
      bRef.child('tasks').off();
      bRef.child('todos').off();
    };
  }, [boardId]);

  const updateTasks = useCallback((updater) => {
    const next = typeof updater === 'function' ? updater(tasksRef.current) : updater;
    tasksRef.current = next;
    setTasks(next);
    if (boardRef.current) boardRef.current.child('tasks').set(next);
  }, []);

  const updateTodos = useCallback((updater) => {
    const next = typeof updater === 'function' ? updater(todosRef.current) : updater;
    todosRef.current = next;
    setTodos(next);
    if (boardRef.current) boardRef.current.child('todos').set(next);
  }, []);

  // Keyboard shortcut: N to add new task (desktop only)
  useEffect(() => {
    const handleKey = (e) => {
      const tag = document.activeElement?.tagName;
      if (e.key === 'n' && !modalOpen && tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') {
        e.preventDefault();
        setActiveColumnId('triage');
        setEditingTask(null);
        setModalOpen(true);
      }
    };
    if (window.innerWidth >= 1024) {
      document.addEventListener('keydown', handleKey);
      return () => document.removeEventListener('keydown', handleKey);
    }
  }, [modalOpen]);

  const handleAddClick = useCallback((columnId) => {
    setActiveColumnId(columnId);
    setEditingTask(null);
    setModalOpen(true);
  }, []);

  const handleEditTask = useCallback((task) => {
    setEditingTask(task);
    setActiveColumnId(null);
    setModalOpen(true);
  }, []);

  const handleDeleteTask = useCallback((taskId) => {
    const task = tasksRef.current.find(t => t.id === taskId);
    if (task) {
      setUndoTask(task);
      clearTimeout(undoTimerRef.current);
      undoTimerRef.current = setTimeout(() => setUndoTask(null), 5000);
    }
    updateTasks(prev => prev.filter(t => t.id !== taskId));
  }, [updateTasks]);

  const handleUndo = useCallback(() => {
    if (undoTask) {
      updateTasks(prev => [...prev, undoTask]);
      setUndoTask(null);
      clearTimeout(undoTimerRef.current);
    }
  }, [undoTask, updateTasks]);

  const handleSaveTask = useCallback((data) => {
    if (editingTask) {
      updateTasks(prev => prev.map(t =>
        t.id === editingTask.id ? { ...t, description: data.description, category: data.category, notes: data.notes } : t
      ));
    } else {
      updateTasks(prev => [...prev, {
        id: generateId(),
        description: data.description,
        category: data.category,
        notes: data.notes,
        columnId: activeColumnId || 'triage',
      }]);
    }
  }, [editingTask, activeColumnId, updateTasks]);

  const handleDrop = useCallback((taskId, targetColumnId, insertBeforeTaskId) => {
    if (taskId === insertBeforeTaskId) return;
    updateTasks(prev => {
      const taskIdx = prev.findIndex(t => t.id === taskId);
      if (taskIdx === -1) return prev;
      const task = { ...prev[taskIdx], columnId: targetColumnId };
      const without = prev.filter(t => t.id !== taskId);
      if (insertBeforeTaskId) {
        const targetIdx = without.findIndex(t => t.id === insertBeforeTaskId);
        if (targetIdx !== -1) {
          without.splice(targetIdx, 0, task);
          return without;
        }
      }
      let lastIdx = -1;
      without.forEach((t, i) => { if (t.columnId === targetColumnId) lastIdx = i; });
      if (lastIdx === -1) return [...without, task];
      without.splice(lastIdx + 1, 0, task);
      return without;
    });
  }, [updateTasks]);

  const handleMoveTask = useCallback((taskId, targetColumnId) => {
    handleDrop(taskId, targetColumnId, null);
  }, [handleDrop]);

  const clearDoneColumn = useCallback(() => {
    if (tasksRef.current.some(t => t.columnId === 'done')) {
      updateTasks(prev => prev.filter(t => t.columnId !== 'done'));
    }
  }, [updateTasks]);

  const handleExport = useCallback(() => {
    const data = JSON.stringify({ tasks: tasksRef.current, version: 2 }, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'marketing-board-backup.json';
    a.click();
    URL.revokeObjectURL(url);
  }, []);

  const handleImport = useCallback(() => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.tasks && Array.isArray(data.tasks)) {
            updateTasks(data.tasks);
          }
        } catch {}
      };
      reader.readAsText(file);
    };
    input.click();
  }, [updateTasks]);

  const handleShare = useCallback(() => {
    const url = window.location.origin + window.location.pathname + '#' + boardId;
    navigator.clipboard.writeText(url).then(() => {
      setShareCopied(true);
      setTimeout(() => setShareCopied(false), 2000);
    }).catch(() => {
      prompt('Copy this link to share your board:', url);
    });
  }, [boardId]);

  const tasksByColumn = useMemo(() => {
    const map = {};
    COLUMNS.forEach(col => { map[col.id] = []; });
    tasks.forEach(t => {
      if (searchQuery && !t.description.toLowerCase().includes(searchQuery.toLowerCase())) return;
      if (filterCategory && t.category !== filterCategory) return;
      if (map[t.columnId]) map[t.columnId].push(t);
      else map['triage'].push(t);
    });
    return map;
  }, [tasks, searchQuery, filterCategory]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="inline-block w-8 h-8 border-2 border-gray-600 rounded-full animate-spin mb-4" style={{ borderTopColor: '#60a5fa' }}></div>
          <p className="text-gray-400 text-sm">Loading your board...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-4 sm:p-6">
      <header className="text-center mb-4 relative">
        <h1 className="text-3xl sm:text-4xl font-bold title-gradient mb-1">Marketing Projects Board</h1>
        <p className="text-gray-400 text-xs tracking-wide">{getGreeting()} &middot; {getFormattedDate()}</p>
        <div className="header-actions-group absolute right-0 top-1/2 -translate-y-1/2 flex items-center gap-2">
          <button
            onClick={handleShare}
            className={`header-action-btn hidden sm:flex items-center gap-1.5 ${shareCopied ? 'share-copied' : ''}`}
            title="Copy share link for cross-device sync"
          >
            <ShareIcon />
            {shareCopied ? 'Copied!' : 'Share'}
          </button>
          <button onClick={handleExport} className="header-action-btn hidden sm:block" title="Export board data">Export</button>
          <button onClick={handleImport} className="header-action-btn hidden sm:block" title="Import board data">Import</button>
          <button
            onClick={() => setSidebarOpen(true)}
            className="sidebar-toggle lg:hidden p-2.5 rounded-xl text-gray-400 hover:text-white"
            style={{ background: 'rgba(30, 41, 59, 0.8)', border: '1px solid rgba(51, 65, 85, 0.5)' }}
            aria-label="Open personal to-dos"
            title="Open personal to-dos"
          >
            <SidebarIcon />
          </button>
        </div>
      </header>

      {/* Search + Filter bar */}
      <div className="search-filter-bar flex items-center gap-3 mb-4 px-1" style={{ maxWidth: '1600px', margin: '0 auto 16px' }}>
        <div className="search-input-wrapper relative flex-1" style={{ maxWidth: '320px' }}>
          <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><SearchIcon /></div>
          <input
            type="text"
            value={searchQuery}
            onChange={e => setSearchQuery(e.target.value)}
            placeholder="Search tasks..."
            className="search-bar w-full pl-9 pr-3 py-2 rounded-lg text-sm text-white placeholder-gray-500"
            style={{ background: 'rgba(15, 23, 42, 0.7)', border: '1px solid rgba(51, 65, 85, 0.5)' }}
          />
        </div>
        <select
          value={filterCategory}
          onChange={e => setFilterCategory(e.target.value)}
          className="px-3 py-2 rounded-lg text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          style={{ background: 'rgba(15, 23, 42, 0.7)', border: '1px solid rgba(51, 65, 85, 0.5)', colorScheme: 'dark' }}
        >
          <option value="">All Categories</option>
          {CATEGORIES.map(cat => (
            <option key={cat.value} value={cat.value}>{cat.label}</option>
          ))}
        </select>
        {(searchQuery || filterCategory) && (
          <button onClick={() => { setSearchQuery(''); setFilterCategory(''); }} className="text-xs text-gray-400 hover:text-white transition-colors">Clear</button>
        )}
        {/* Mobile: three-dot menu replaces individual buttons */}
        <MoreMenu onShare={handleShare} onExport={handleExport} onImport={handleImport} shareCopied={shareCopied} />
      </div>

      {/* Mobile column tabs */}
      <ColumnTabs activeTab={mobileColumnTab} onTabChange={setMobileColumnTab} tasksByColumn={tasksByColumn} />

      <div className="flex gap-5 px-1" style={{ maxWidth: '1600px', margin: '0 auto' }}>
        <div className="columns-scroll-wrapper flex-1 min-w-0">
          <div className="flex gap-5 overflow-x-auto pb-2">
            {COLUMNS.map(column => (
              <Column
                key={column.id}
                column={column}
                tasks={tasksByColumn[column.id]}
                onAddClick={handleAddClick}
                onEditTask={handleEditTask}
                onDeleteTask={handleDeleteTask}
                onDrop={handleDrop}
                onMoveTask={handleMoveTask}
                onClearDone={column.id === 'done' ? clearDoneColumn : undefined}
                hidden={isMobile && column.id !== mobileColumnTab}
              />
            ))}
          </div>
        </div>

        <div className="hidden lg:block flex-shrink-0 self-stretch" style={{ width: '1px', background: 'linear-gradient(to bottom, transparent, rgba(100, 116, 139, 0.4) 15%, rgba(100, 116, 139, 0.4) 85%, transparent)' }} />

        <div className="hidden lg:block flex-shrink-0">
          <PersonalSidebar todos={todos} updateTodos={updateTodos} />
        </div>
      </div>

      <MobileSidebarOverlay isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} todos={todos} updateTodos={updateTodos} />

      <TaskModal
        isOpen={modalOpen}
        onClose={() => setModalOpen(false)}
        onSave={handleSaveTask}
        initialData={editingTask}
        defaultColumn={activeColumnId}
      />

      {undoTask && (
        <UndoToast
          message="Task deleted"
          onUndo={handleUndo}
          onDismiss={() => { setUndoTask(null); clearTimeout(undoTimerRef.current); }}
        />
      )}

      {/* Keyboard hint - desktop only */}
      <div className="fixed bottom-4 left-1/2 -translate-x-1/2 text-gray-400 text-xs hidden lg:block" style={{ pointerEvents: 'none' }}>
        Press <kbd className="px-1.5 py-0.5 rounded text-gray-300" style={{ background: '#1e293b', border: '1px solid #475569' }}>N</kbd> to add a new task
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);
</script>
</body>
</html>
